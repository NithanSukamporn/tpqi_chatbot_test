<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCG AI Assistant - ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        #chatbox::-webkit-scrollbar { width: 6px; }
        #chatbox::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .bot-bubble { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem 1.5rem 1.5rem 1.5rem; }
        .user-bubble { background: #eff6ff; border: 1px solid #dbeafe; border-radius: 1.5rem 0.5rem 1.5rem 1.5rem; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-80 bg-[#f1f5f9] border-r flex flex-col p-5 hidden lg:flex">
        <div class="flex items-center gap-3 mb-8">
            <div class="bg-white p-2 rounded-full shadow-sm">
                <img src="https://tpqi.go.th/img/logo.png" alt="TPQI" class="h-10"> 
            </div>
            <div>
                <h1 class="font-bold text-slate-800 leading-tight">TPQI</h1>
                <p class="text-xs text-slate-500">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</p>
            </div>
        </div>

        <div class="flex-grow space-y-6">
            <div>
                <button id="uploadTrigger" class="w-full flex items-center justify-center gap-2 bg-white border-2 border-dashed border-slate-300 p-4 rounded-xl text-slate-600 hover:bg-white/50 transition">
                    <span class="text-xl">‚Üë</span> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </button>
                <input type="file" id="imageUploadInput" class="hidden" accept="image/*,application/pdf">
            </div>

            <div class="space-y-2">
                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</p>
                <div id="fileList" class="space-y-2">
                    </div>
            </div>
        </div>

        <div class="pt-4 border-t border-slate-200">
            <button class="flex items-center gap-2 text-sm text-slate-500 hover:text-slate-800">
                üõ°Ô∏è ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (PDPA)
            </button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col bg-white">
        <header class="h-16 border-b flex items-center justify-between px-6 bg-white/80 backdrop-blur-md z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                    ü§ñ
                </div>
                <div>
                    <h2 class="font-bold text-slate-800">LCG AI Assistant</h2>
                    <p class="text-[10px] text-emerald-500 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏π‡πà‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-4 text-xs text-slate-400">
                <span id="firestoreStatus">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
        </header>

        <div id="chatbox" class="flex-grow overflow-y-auto p-4 lg:p-10 space-y-6">
            <div class="flex gap-4 max-w-3xl mx-auto">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs flex-shrink-0">AI</div>
                <div class="bot-bubble p-4 shadow-sm max-w-[85%] text-slate-700">
                    <p class="font-bold mb-2">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ LCG AI Assistant</p>
                    <p class="text-sm">‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:</p>
                    <ul class="list-disc ml-5 mt-2 text-sm space-y-1">
                        <li>‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û TPQI</li>
                        <li>‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</li>
                        <li>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</li>
                    </ul>
                </div>
            </div>
        </div>

        <footer class="p-4 lg:p-6 border-t bg-white">
            <div class="max-w-3xl mx-auto">
                <div id="loadingIndicator" class="hidden mb-2 text-xs text-blue-600 animate-pulse">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...
                </div>
                <div class="relative flex items-end gap-2 bg-slate-50 border border-slate-200 p-2 rounded-2xl focus-within:border-blue-400 transition shadow-sm">
                    <textarea id="promptInput" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... (‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á)" 
                              class="w-full bg-transparent p-3 outline-none resize-none text-slate-700 max-h-32"></textarea>
                    <button id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                    </button>
                </div>
                <p class="text-[10px] text-center text-slate-400 mt-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà AI ‡∏ï‡∏≠‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</p>
            </div>
        </footer>
    </main>

    <script type="module">
        // üîπ CONFIGURATION (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const RENDER_BACKEND_URL = "https://tpqi-chatbot-test.onrender.com/chat"; 
        const firebaseConfig = {
            apiKey: "AIzaSyCk_zCsIaNZs_kNSkiiPrEkeSgc-0TAg9A",
            authDomain: "tpqi-3725e.firebaseapp.com",
            projectId: "tpqi-3725e",
            storageBucket: "tpqi-3725e.firebasestorage.app",
            messagingSenderId: "683779606168",
            appId: "1:683779606168:web:73d58ba750669fbbb572ed"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Init
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = 'anonymous';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('firestoreStatus').textContent = `‚úÖ Online`;
            } else {
                await signInAnonymously(auth);
            }
        });

        // UI Logic
        const promptInput = document.getElementById('promptInput');
        const sendButton = document.getElementById('sendButton');
        const chatbox = document.getElementById('chatbox');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const fileList = document.getElementById('fileList');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
        function addMessage(text, sender) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-4 max-w-3xl mx-auto ${sender === 'user' ? 'justify-end' : ''}`;
            
            const avatar = sender === 'user' ? '' : `<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs flex-shrink-0">AI</div>`;
            const bubbleClass = sender === 'user' ? 'user-bubble' : 'bot-bubble';
            
            wrapper.innerHTML = `
                ${avatar}
                <div class="${bubbleClass} p-4 shadow-sm max-w-[85%] text-slate-700 text-sm whitespace-pre-wrap">
                    ${text}
                </div>
            `;
            chatbox.appendChild(wrapper);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏≤ Render
        async function sendMessage() {
            const text = promptInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            promptInput.value = '';
            loadingIndicator.classList.remove('hidden');
            
            try {
                const response = await fetch(RENDER_BACKEND_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: text })
                });
                const data = await response.json();
                addMessage(data.answer || "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", 'bot');
                
                // ‡πÄ‡∏Å‡πá‡∏ö Log ‡∏•‡∏á Firebase (Ticket Data ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
                await addDoc(collection(db, `chat_logs`), {
                    userId,
                    message: text,
                    answer: data.answer,
                    timestamp: new Date().toISOString()
                });

            } catch (error) {
                addMessage(`‚ùå Error: ${error.message}`, 'bot');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå (Sidebar)
        document.getElementById('uploadTrigger').onclick = () => imageUploadInput.click();
        imageUploadInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const item = document.createElement('div');
                item.className = "p-3 bg-white rounded-lg border border-slate-200 text-xs flex items-center gap-2 shadow-sm";
                item.innerHTML = `üìÑ <span class="truncate flex-grow">${file.name}</span> <span class="text-emerald-500 text-[10px]">‚úî</span>`;
                fileList.appendChild(item);
            }
        };

        // Event Listeners
        sendButton.onclick = sendMessage;
        promptInput.onkeypress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
    </script>
</body>
</html>